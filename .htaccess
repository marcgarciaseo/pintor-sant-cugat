# ===================================
# .htaccess para Reformas Martí Granollers
# Optimización SEO, Seguridad y Rendimiento
# ===================================

# ===================================
# 1. FORZAR HTTPS (SSL)
# ===================================
RewriteEngine On

# Redirección HTTP a HTTPS (compatible con cPanel/Raiola y Cloudflare)
# Opción 1: Si HTTPS está desactivado
RewriteCond %{HTTPS} off
RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# Opción 2: Si está detrás de proxy (Cloudflare, etc.)
RewriteCond %{HTTP:X-Forwarded-Proto} !https
RewriteCond %{HTTPS} off
RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# Opción 3: Forzar HTTPS en servidor (método alternativo)
RewriteCond %{SERVER_PORT} 80
RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# ===================================
# 2. REDIRECCIÓN WWW (elige una opción)
# ===================================
# Opción A: Forzar www (elige esta O la de abajo, no ambas)
# RewriteCond %{HTTP_HOST} !^www\. [NC]
# RewriteRule ^(.*)$ https://www.%{HTTP_HOST}/$1 [R=301,L]

# Opción B: Forzar sin www (RECOMENDADO para este proyecto)
RewriteCond %{HTTP_HOST} ^www\.(.*)$ [NC]
RewriteRule ^(.*)$ https://%1/$1 [R=301,L]

# ===================================
# 3. URLs LIMPIAS (sin .html)
# ===================================
# Remover .html si lo escribe el usuario
RewriteCond %{THE_REQUEST} /([^.]+)\.html [NC]
RewriteRule ^ /%1/ [NC,L,R=301]

# Agregar .html internamente si la URL no tiene extensión
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME}\.html -f
RewriteRule ^([^/]+)/$ $1.html [L]

# Manejar URLs sin barra final
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !/$
RewriteRule ^(.*)$ $1/ [L,R=301]

# ===================================
# 4. COMPRESIÓN GZIP
# ===================================
<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json application/xml
</IfModule>

# ===================================
# 5. CACHE DEL NAVEGADOR
# ===================================
<IfModule mod_expires.c>
  ExpiresActive On
  
  # Imágenes
  ExpiresByType image/jpeg "access plus 1 year"
  ExpiresByType image/png "access plus 1 year"
  ExpiresByType image/gif "access plus 1 year"
  ExpiresByType image/webp "access plus 1 year"
  ExpiresByType image/svg+xml "access plus 1 year"
  ExpiresByType image/x-icon "access plus 1 year"
  
  # CSS y JavaScript
  ExpiresByType text/css "access plus 1 month"
  ExpiresByType application/javascript "access plus 1 month"
  ExpiresByType text/javascript "access plus 1 month"
  
  # Fuentes
  ExpiresByType font/woff2 "access plus 1 year"
  ExpiresByType font/woff "access plus 1 year"
  ExpiresByType font/ttf "access plus 1 year"
  
  # HTML (no hacer cache para que siempre esté actualizado)
  ExpiresByType text/html "access plus 0 seconds"
</IfModule>

# ===================================
# 6. SEGURIDAD
# ===================================
# Ocultar información del servidor
ServerSignature Off

# Headers de seguridad adicionales
<IfModule mod_headers.c>
  # Prevenir clickjacking
  Header always set X-Frame-Options "SAMEORIGIN"
  # Prevenir MIME type sniffing
  Header always set X-Content-Type-Options "nosniff"
  # XSS Protection
  Header always set X-XSS-Protection "1; mode=block"
  # Referrer Policy
  Header always set Referrer-Policy "strict-origin-when-cross-origin"
</IfModule>

# Prevenir acceso a archivos ocultos
<FilesMatch "^\.">
  Order allow,deny
  Deny from all
</FilesMatch>

# Bloquear acceso a archivos de desarrollo
<FilesMatch "\.(ps1|bat|md|gitignore|htaccess)$">
  Order allow,deny
  Deny from all
</FilesMatch>

# ===================================
# 7. PÁGINAS DE ERROR PERSONALIZADAS
# ===================================
ErrorDocument 404 /404.html
ErrorDocument 500 /500.html

# ===================================
# 8. TIPO MIME CORRECTO
# ===================================
<IfModule mod_mime.c>
  AddType text/css .css
  AddType application/javascript .js
  AddType image/svg+xml .svg
  AddType application/manifest+json .json
</IfModule>

# ===================================
# 9. BLOQUEAR HOTLINKING DE IMÁGENES
# ===================================
# Nota: RewriteEngine ya está activado arriba, no hace falta repetirlo
RewriteCond %{HTTP_REFERER} !^$
RewriteCond %{HTTP_REFERER} !^https?://(www\.)?pintorsantcugat\.es [NC]
RewriteRule \.(jpg|jpeg|png|gif|webp|svg)$ - [NC,F,L]

# ===================================
# 10. CHARSET UTF-8
# ===================================
AddDefaultCharset UTF-8

